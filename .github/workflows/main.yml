name: Deploy to VM # TÃªn cá»§a workflow, sáº½ hiá»ƒn thá»‹ trÃªn tab Actions cá»§a GitHub

on:
  push: # Sá»± kiá»‡n kÃ­ch hoáº¡t workflow
    branches:
      - main # Chá»‰ cháº¡y khi cÃ³ push lÃªn nhÃ¡nh 'main'. Báº¡n cÃ³ thá»ƒ Ä‘á»•i thÃ nh nhÃ¡nh khÃ¡c.

jobs:
  deploy:
    name: Deploy Code to VM
    runs-on: self-hosted 

    steps:
      - name: Print Starting Message
        run: echo "ðŸš€ Starting deployment process on VM via GitHub Actions..."

      - name: Checkout repository
        uses: actions/checkout@v4 

      - name: Pull latest code into project directory
        run: |
          echo "Navigating to project directory and pulling latest code..."
          cd /home/vagrant/test_action_github
          git pull origin main
          echo "âœ… Code pulled successfully!"

      - name: Install/Update Node.js dependencies
        run: |
          echo "Installing/updating dependencies..."
          cd /home/vagrant/test_action_github
          npm install --production 
          echo "âœ… Dependencies installed/updated!"

      - name: Restart Node.js Application
        run: |
          echo "Gracefully restarting Node.js application with PM2..."
          pm2 restart my-api
          echo "âœ… Application restarted via PM2!"